version: "3.8"

services:
  rage:
    container_name: rage
    extends:
      file: ./docker-compose-common.yml
      service: micro
    image: fluffycore.rage.oidc:latest
    ports:
      - "50051:50051"
      - "50052:50052"
      - "50053:50053"
      - "9044:9044"
    environment:
      ENABLE_GRPC_SERVER_REFLECTION: "true"
      APPLICATION_NAME: "starterkit"
      APPLICATION_ENVIRONMENT: "DOCKER"
      LOG_LEVEL": "debug"
      PRETTY_LOG: "true"
      PORT: "50051"
      GRPC_GATEWAY_ENABLED: "true"
      REST_PORT: "50052"
      oauth2Port: "50053"
      customString: "In Flames"
      someSecret: "1234567890"
      jwtValidators__issuers: "http://starterkit:50053"
      jwtValidators__jwksUrls: "http://starterkit:50053/.well-known/jwks"
      configFiles__mockOAuth2ClientPath: "/config/mockOAuth2Clients.json"
      configFiles__oidcClientPath: "/config/oidcClients.json"
    volumes:
      - ./cmd/server/config/mockOAuth2Clients.json:/config/mockOAuth2Clients.json
      - ./cmd/server/config/oidcClients.json:/config/oidcClients.json
    entrypoint: ["/app/server", "serve"]
  smtp4dev:
    extends:
      file: ./docker-compose-common.yml
      service: micro
    container_name: smtp4dev-fluffycore
    image: rnwood/smtp4dev:v3
    restart: always
    ports:
      # Change the number before : to the port the web interface should be accessible on
      - "5000:80"
      # Change the number before : to the port the SMTP server should be accessible on
      - "25:25"
      # Change the number before : to the port the IMAP server should be accessible on
      - "143:143"
    volumes:
      # This is where smtp4dev stores the database..
      - smtp4dev-data:/smtp4dev
    environment:
      # Uncomment to customise these settings

      #Specifies the virtual path from web server root where SMTP4DEV web interface will be hosted. e.g. "/" or "/smtp4dev"
      #- ServerOptions__BasePath=/smtp4dev

      #Specifies the server hostname. Used in auto-generated TLS certificate if enabled.
      - ServerOptions__HostName=smtp4dev

      #Locks settings from being changed by user via web interface
      #- ServerOptions__LockSettings=true

      #Specifies the path where the database will be stored relative to APPDATA env var on Windows or XDG_CONFIG_HOME on non-Windows. Specify "" to use an in memory database.
      #- ServerOptions__Database=database.db

      #Specifies the number of messages to keep
      #- ServerOptions__NumberOfMessagesToKeep=100

      #Specifies the number of sessions to keep
      #- ServerOptions__NumberOfSessionsToKeep=100

      #Specifies the TLS mode to use. None=Off. StartTls=On demand if client supports STARTTLS. ImplicitTls=TLS as soon as connection is established.
      #- ServerOptions__TlsMode=None

      #Specifies the TLS certificate to use if TLS is enabled/requested. Specify "" to use an auto-generated self-signed certificate (then see console output on first startup)
      #- ServerOptions__TlsCertificate=

      #Sets the name of the SMTP server that will be used to relay messages or "" if messages should not be relayed
      #- RelayOptions__SmtpServer=

      #Sets the port number for the SMTP server used to relay messages.
      #- RelayOptions__SmtpPort=25

      #Specifies a comma separated list of recipient addresses for which messages will be relayed. An empty list means that no messages are relayed.
      #- RelayOptions__AllowedEmailsString=

      #Specifies the address used in MAIL FROM when relaying messages. (Sender address in message headers is left unmodified). The sender of each message is used if not specified.
      #- RelayOptions__SenderAddress=

      #The username for the SMTP server used to relay messages. If "" no authentication is attempted.
      #- RelayOptions__Login=

      #The password for the SMTP server used to relay messages
      #- RelayOptions__Password=

      #Specifies the port the IMAP server will listen on - allows standard email clients to view/retrieve messages
      #"ServerOptions__ImapPort"=143
  whoami:
    container_name: whoami
    extends:
      file: ./docker-compose-common.yml
      service: micro
    image: containous/whoami
    security_opt:
      - no-new-privileges:true
    depends_on:
      rage:
        condition: service_healthy

volumes:
  smtp4dev-data:
